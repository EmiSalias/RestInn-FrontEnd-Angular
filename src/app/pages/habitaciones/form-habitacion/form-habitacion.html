<main class="page-habitacion">
  <section class="form-card">
    <h2>{{ editMode ? 'Editar habitaci√≥n' : 'Crear habitaci√≥n' }}</h2>

    <form [formGroup]="form" (ngSubmit)="onSubmit()">

      <div class="grid-2">
        
        <!-- CAMPO NUMERO -->
        <div class="field">
          <label for="numeroHab">N√∫mero</label>
          <input id="numeroHab" type="number" formControlName="numero" min="1" max="9999" placeholder="Ej: 101" />
          
          <!-- MENSAJE DE VERIFICACION -->
          @if (form.get('numero')?.pending) {
            <small class="hint">Verificando disponibilidad...</small>
          }

          <!-- MENSAJE EN CASO DE VALIDO -->
          @if (form.get('numero')?.valid && (form.get('numero')?.touched || form.get('numero')?.dirty) && !form.get('numero')?.pending) {
            <small class="success">‚úì N√∫mero disponible</small>
          }

          <!-- MENSAJES EN CASO DE ERROR -->
          @if (form.get('numero')?.touched && form.get('numero')?.invalid && !form.get('numero')?.pending) {
            <div class="errors-container">
              @if (form.get('numero')?.hasError('required')) {
                <small class="error">El n√∫mero es obligatorio.</small>
              }
              @if (form.get('numero')?.hasError('min')) {
                <small class="error">No puede ser negativo ni cero.</small>
              }
              @if (form.get('numero')?.hasError('max')) {
                <small class="error">M√°ximo permitido: 9999.</small>
              }
              @if (form.get('numero')?.hasError('numeroDuplicado')) {
                <small class="error">Ya existe una habitaci√≥n con este n√∫mero.</small>
              }
            </div>
          }
        </div>

        <!-- CAMPO PISO -->
        <div class="field">
          <label for="pisoHab">Piso</label>
          <input id="pisoHab" type="number" formControlName="piso" min="1" max="4" placeholder="1-4" />
          
          <!-- MENSAJE EN CASO DE VALIDO -->
          @if (form.get('piso')?.valid && (form.get('piso')?.dirty || form.get('piso')?.touched)) {
            <small class="success">‚úì Piso v√°lido</small>
          }

          <!-- MENSAJES EN CASO DE ERROR -->
          @if (form.get('piso')?.touched && form.get('piso')?.invalid) {
            <div class="errors-container">
              @if (form.get('piso')?.hasError('required')) {
                <small class="error">El piso es obligatorio.</small>
              }
              @if (form.get('piso')?.hasError('min')) {
                <small class="error">El piso m√≠nimo es 1.</small>
              }
              @if (form.get('piso')?.hasError('max')) {
                <small class="error">El piso m√°ximo es 4.</small>
              }
            </div>
          }
        </div>

        <!-- CAMPO CAPACIDAD -->
        <div class="field">
          <label>Capacidad</label>
          <input id="capacHab" type="number" formControlName="capacidad" min="1" max="5" placeholder="1-5" />

          <!-- MENSAJE EN CASO DE VALIDO -->
          @if (form.get('capacidad')?.valid && (form.get('capacidad')?.dirty || form.get('capacidad')?.touched)) {
            <small class="success">‚úì Capacidad v√°lida</small>
          }

          <!-- MENSAJES EN CASO DE ERROR -->
          @if (form.get('capacidad')?.invalid && (form.get('capacidad')?.dirty || form.get('capacidad')?.touched)) {
            <div class="errors-container">
              @if (form.get('capacidad')?.hasError('required')) {
                <small class="error">La capacidad es obligatoria.</small>
              }
              @if (form.get('capacidad')?.hasError('min')) {
                <small class="error">M√≠nimo 1 persona.</small>
              }
              @if (form.get('capacidad')?.hasError('max')) {
                <small class="error">M√°ximo 5 personas.</small>
              }
            </div>
          }
        </div>

        <!-- CAMPO CAMAS -->
        <div class="field">
          <label>Camas</label>
          <input id="camasHab" type="number" formControlName="cantCamas" min="1" max="4" placeholder="1-4" />

          <!-- MENSAJE EN CASO DE VALIDO -->
          @if (form.get('cantCamas')?.valid && (form.get('cantCamas')?.dirty || form.get('cantCamas')?.touched)) {
            <small class="success">‚úì Cantidad de camas v√°lida</small>
          }

          <!-- MENSAJES EN CASO DE ERROR -->
          @if (form.get('cantCamas')?.invalid && (form.get('cantCamas')?.dirty || form.get('cantCamas')?.touched)) {
            <div class="errors-container">
              @if (form.get('cantCamas')?.hasError('required')) {
                <small class="error">La cantidad de camas es obligatoria.</small>
              }
              @if (form.get('cantCamas')?.hasError('min')) {
                <small class="error">M√≠nimo 1 cama.</small>
              }
              @if (form.get('cantCamas')?.hasError('max')) {
                <small class="error">M√°ximo 4 camas.</small>
              }
            </div>
          }
        </div>

        <!-- CAMPO PRECIO -->
        <div class="field">
          <label>Precio por noche</label>
          <input id="precioHab" type="number" formControlName="precioNoche" min="0.01" max="999999999.99" step="0.01" placeholder="$" />

          <!-- MENSAJE EN CASO DE VALIDO -->
          @if (form.get('precioNoche')?.valid && (form.get('precioNoche')?.dirty || form.get('precioNoche')?.touched)) {
            <small class="success">‚úì Precio v√°lido</small>
          }

          <!-- MENSAJES EN CASO DE ERROR -->
          @if (form.get('precioNoche')?.invalid && (form.get('precioNoche')?.dirty || form.get('precioNoche')?.touched)) {
            <div class="errors-container">
              @if (form.get('precioNoche')?.hasError('required')) {
                <small class="error">El precio es obligatorio.</small>
              }
              @if (form.get('precioNoche')?.hasError('min')) {
                <small class="error">M√≠nimo $0.01</small>
              }
              @if (form.get('precioNoche')?.hasError('max')) {
                <small class="error">M√°ximo $999999999.99</small>
              }
            </div>
          }
        </div>

        <!-- CAMPO ESTADO -->
        <div class="field">
          <label>Estado</label>
          <select formControlName="estado">

            <!-- MANEJO DE ESTADO -->
            @for (estado of estadosPermitidos; track estado) {
              <option [value]="estado">{{ estado | titlecase }}</option>
            }
          </select>
        </div>

        <!-- CAMPO TIPO -->
        <div class="field">
          <label>Tipo</label>
          <select formControlName="tipo">
            <option value="SIMPLE">Simple</option>
            <option value="DOBLE">Doble</option>
            <option value="TRIPLE">Triple</option>
            <option value="CUADRUPLE">Cu√°druple</option>
            <option value="DELUXE">Deluxe</option>
          </select>
        </div>

        <!-- CAMPO ACTIVO -->
        @if (editMode) {
          <div class="field field-toggle">
            <label for="activo">Habitaci√≥n Activa</label>
            <label class="switch">
              <input type="checkbox" id="activo" formControlName="activo">
              <span class="slider round"></span>
            </label>
            <small class="hint">Desmarcar para inhabilitar. Marcar para reactivar.</small>
          </div>
        }
      </div>

      <!-- CAMPO COMENTARIO -->
      <div class="field">
          <label>Comentario (Opcional)</label>
          <textarea rows="2" formControlName="comentario" placeholder="Detalles adicionales..."></textarea>

          <!-- MENSAJES EN CASO DE ERROR -->
          @if (form.get('comentario')?.hasError('maxlength') && (form.get('comentario')?.dirty || form.get('comentario')?.touched)) {
            <small class="error">
              El comentario es muy largo (m√°ximo 255 caracteres). 
              Est√°s usando {{ form.get('comentario')?.errors?.['maxlength'].actualLength }}.
            </small>
          }
        </div>

      <!-- CAMPO IMAGENES -->
      <div class="field">
        <label>Im√°genes <small class="hint">({{ imagenesPreview.length }} / 30)</small></label>
        
        <div 
          class="upload-container"
          [class.dragging]="isDragging"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)">
          
          <input 
            type="file" 
            id="fileInput" 
            multiple 
            (change)="onFilesSelected($event)" 
            accept="image/*" 
            hidden 
          />

          <label for="fileInput" class="upload-btn">
            <span class="icon">üìÅ</span> Elegir archivos
          </label>

          <span class="upload-hint">
            @if (isDragging) {
              ¬°Solt√° los archivos ac√°!
            } @else {
              o arrastralos y soltalos aqu√≠
            }
          </span>
        </div>
        
        @if (imageError) {
          <small class="error">{{ imageError }}</small>
        }
      </div>

      <!-- GESTION Y VISUALIZACION DE IMAGENES -->
      @if (imagenesPreview.length > 0) {
        <section class="galeria">
          <div class="galeria__thumbs">
            @for (img of imagenesPreview; let i = $index; track $index) {
              <div class="thumb">
                <img [src]="img.url" [alt]="'Imagen ' + (i + 1)" />
                <button type="button" class="btn-remove" (click)="removeImage(i)" title="Eliminar imagen">‚úï</button>
              </div>
            }
          </div>
        </section>
      } @else {
        <div class="galeria galeria--empty">Sin im√°genes cargadas</div>
      }

      <!-- BOTONES -->
      <div class="actions">
        <button type="submit" [disabled]="loading || form.invalid">
          @if (loading) {
            <span>Guardando...</span>
          } @else {
            <span>{{ editMode ? 'Guardar cambios' : 'Crear habitaci√≥n' }}</span>
          }
        </button>
        <button type="button" class="btn-ghost" (click)="volver()">Cancelar</button>
      </div>
    </form>
  </section>
</main>