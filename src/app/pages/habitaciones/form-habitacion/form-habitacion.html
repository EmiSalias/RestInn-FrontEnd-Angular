<h1 class="gest-habs" routerLink="/gestion_habitaciones">Gesti√≥n de habitaciones</h1>
<h1>></h1>
<h1>Crear habitaci√≥n</h1>
<main class="page-habitacion">
  <section class="form-card">
    <h2>{{ editMode ? 'Editar habitaci√≥n' : 'Nueva habitaci√≥n' }}</h2>

    <form [formGroup]="form" (ngSubmit)="onSubmit()">

      <div class="grid-2">
        
        <!-- CAMPO NUMERO -->
        <div class="field">
          <label for="numeroHab">N√∫mero</label>
          @if (!isAdmin) {
            <input type="number" formControlName="numero" readonly />
          } @else {
            <input id="numeroHab" type="number" formControlName="numero" min="1" max="999" placeholder="Ej: 101" />
          }
          @if (form.get('numero')?.pending && isAdmin) {
            <small class="hint">Verificando disponibilidad...</small>
          }

          @if (form.get('numero')?.valid && (form.get('numero')?.touched || form.get('numero')?.dirty) && !form.get('numero')?.pending && isAdmin) {
            <small class="success">‚úì N√∫mero disponible</small>
          }

          @if (form.get('numero')?.touched && form.get('numero')?.invalid && !form.get('numero')?.pending) {
            <div class="errors-container">
              @if (form.get('numero')?.hasError('required')) {
                <small class="error">El n√∫mero es obligatorio.</small>
              }
              @if (form.get('numero')?.hasError('min')) {
                <small class="error">No puede ser negativo ni cero.</small>
              }
              @if (form.get('numero')?.hasError('max')) {
                <small class="error">M√°ximo permitido: 999.</small>
              }
              @if (form.get('numero')?.hasError('numeroDuplicado')) {
                <small class="error">Ya existe una habitaci√≥n con este n√∫mero.</small>
              }
            </div>
          }
        </div>

        <!-- CAMPO PISO -->
        <div class="field">
          <label for="pisoHab">Piso</label>
          @if (!isAdmin) {
            <input type="number" formControlName="piso" readonly />
          } @else {
            <input id="pisoHab" type="number" formControlName="piso" min="1" max="4" placeholder="1-4" />
          }
          @if (form.get('piso')?.valid && (form.get('piso')?.dirty || form.get('piso')?.touched) && isAdmin) {
            <small class="success">‚úì Piso v√°lido</small>
          }
          @if (form.get('piso')?.touched && form.get('piso')?.invalid) {
            <div class="errors-container">
              @if (form.get('piso')?.hasError('required')) {
                <small class="error">El piso es obligatorio.</small>
              }
              @if (form.get('piso')?.hasError('min')) {
                <small class="error">El piso m√≠nimo es 1.</small>
              }
              @if (form.get('piso')?.hasError('max')) {
                <small class="error">El piso m√°ximo es 4.</small>
              }
            </div>
          }
        </div>

        <!-- CAMPO CAPACIDAD -->
        <div class="field">
          <label>Capacidad</label>
          @if (!isAdmin) {
            <input type="number" formControlName="capacidad" readonly />
          } @else {
            <input id="capacHab" type="number" formControlName="capacidad" min="1" max="5" placeholder="1-5" />
          }
          @if (form.get('capacidad')?.valid && (form.get('capacidad')?.dirty || form.get('capacidad')?.touched) && isAdmin) {
            <small class="success">‚úì Capacidad v√°lida</small>
          }
          @if (form.get('capacidad')?.invalid && (form.get('capacidad')?.dirty || form.get('capacidad')?.touched)) {
            <div class="errors-container">
              @if (form.get('capacidad')?.hasError('required')) {
                <small class="error">La capacidad es obligatoria.</small>
              }
              @if (form.get('capacidad')?.hasError('min')) {
                <small class="error">M√≠nimo 1 persona.</small>
              }
              @if (form.get('capacidad')?.hasError('max')) {
                <small class="error">M√°ximo 5 personas.</small>
              }
            </div>
          }
        </div>

        <!-- CAMPO CAMAS -->
        <div class="field">
          <label>Camas</label>
          @if (!isAdmin) {
            <input type="number" formControlName="cantCamas" readonly />
          } @else {
            <input id="camasHab" type="number" formControlName="cantCamas" min="1" max="4" placeholder="1-4" />
          }
          @if (form.get('cantCamas')?.valid && (form.get('cantCamas')?.dirty || form.get('cantCamas')?.touched) && isAdmin) {
            <small class="success">‚úì Cantidad de camas v√°lida</small>
          }
          @if (form.get('cantCamas')?.invalid && (form.get('cantCamas')?.dirty || form.get('cantCamas')?.touched)) {
            <div class="errors-container">
              @if (form.get('cantCamas')?.hasError('required')) {
                <small class="error">La cantidad de camas es obligatoria.</small>
              }
              @if (form.get('cantCamas')?.hasError('min')) {
                <small class="error">M√≠nimo 1 cama.</small>
              }
              @if (form.get('cantCamas')?.hasError('max')) {
                <small class="error">M√°ximo 4 camas.</small>
              }
            </div>
          }
        </div>

        <!-- CAMPO PRECIO -->
        <div class="field">
          <label>Precio por noche</label>
          @if (!isAdmin) {
            <input type="number" formControlName="precioNoche" readonly />
          } @else {
            <input id="precioHab" type="number" formControlName="precioNoche" min="0.01" max="999999999.99" step="0.01" placeholder="$" />
          }
          @if (form.get('precioNoche')?.valid && (form.get('precioNoche')?.dirty || form.get('precioNoche')?.touched) && isAdmin) {
            <small class="success">‚úì Precio v√°lido</small>
          }
          @if (form.get('precioNoche')?.invalid && (form.get('precioNoche')?.dirty || form.get('precioNoche')?.touched)) {
            <div class="errors-container">
              @if (form.get('precioNoche')?.hasError('required')) {
                <small class="error">El precio es obligatorio.</small>
              }
              @if (form.get('precioNoche')?.hasError('min')) {
                <small class="error">M√≠nimo $0.01</small>
              }
              @if (form.get('precioNoche')?.hasError('max')) {
                <small class="error">M√°ximo $999999999.99</small>
              }
            </div>
          }
        </div>

        <!-- CAMPO ESTADO -->
        <div class="field">
          <label>Estado</label>
          <select formControlName="estado">

            @for (estado of estadosPermitidos; track estado) {
              <option [value]="estado">{{ estado | titlecase }}</option>
            }
          </select>
        </div>
        
        <!-- CAMPO TIPO -->
        <div class="field">
          <label>Tipo</label>
          @if (!isAdmin) {
            <input type="text" formControlName="tipo" readonly />
          } @else {
            <select formControlName="tipo">
              <option value="SIMPLE">Simple</option>
              <option value="DOBLE">Doble</option>
              <option value="TRIPLE">Triple</option>
              <option value="CUADRUPLE">Cu√°druple</option>
              <option value="DELUXE">Deluxe</option>
              <option value="INDIVIDUAL">Individual</option>
              <option value="SUITE">Suite</option>
              <option value="ESTUDIO">Estudio</option>
            </select>
        }
        </div>

        <!-- CAMPO ACTIVO -->
        @if (editMode && isAdmin) {
          <div class="field field-toggle">
            <label for="activo">Habitaci√≥n Activa</label>
            <label class="switch">
              <input type="checkbox" id="activo" formControlName="activo">
              <span class="slider round"></span>
            </label>
            <small class="hint">Desmarcar para inhabilitar. Marcar para reactivar.</small>
          </div>
        }
      </div>

      <!-- CAMPO COMENTARIO -->
      <div class="field">
        @if (isAdmin) {
          <label>Comentario (Opcional)</label>
          <textarea rows="2" formControlName="comentario" placeholder="Detalles adicionales..."></textarea>
        } @else {
          <label>Comentario</label>
          @if (form.get('comentario')?.value) {
            <textarea rows="2" formControlName="comentario" readonly></textarea>
          } @else {
            <label class="non_comment">Sin comentario</label>
          }
        }
        @if (form.get('comentario')?.hasError('maxlength') && (form.get('comentario')?.dirty || form.get('comentario')?.touched)) {
          <small class="error">
            El comentario es muy largo (m√°ximo 255 caracteres). 
            Est√°s usando {{ form.get('comentario')?.errors?.['maxlength'].actualLength }}.
          </small>
        }
      </div>

      <!-- CAMPO IMAGENES -->
      @if (isAdmin) {
        <div class="field">
          <label>Im√°genes <small class="hint">({{ imagenesPreview.length }} / 5)</small></label>
          
          <div 
            class="upload-container"
            [class.dragging]="isDragging"
            (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave($event)"
            (drop)="onDrop($event)">
            
            <input 
              type="file" 
              id="fileInput" 
              multiple 
              (change)="onFilesSelected($event)" 
              accept="image/*" 
              hidden 
            />

            <label for="fileInput" class="upload-btn">
              <span class="icon">üìÅ</span> Elegir archivos
            </label>

            <span class="upload-hint">
              @if (isDragging) {
                ¬°Solt√° los archivos ac√°!
              } @else {
                o arrastralos y soltalos aqu√≠
              }
            </span>
          </div>
          
          @if (imageError) {
            <small class="error">{{ imageError }}</small>
          }
        </div>

        <!-- GESTION Y VISUALIZACION DE IMAGENES -->
        @if (imagenesPreview.length > 0) {
          <section class="galeria">
            <div class="galeria__thumbs">
              @for (img of imagenesPreview; let i = $index; track $index) {
                <div class="thumb">
                  <img draggable="false" [src]="img.url" [alt]="'Imagen ' + (i + 1)" />
                  <button type="button" class="btn-remove" (click)="removeImage(i)" title="Eliminar imagen">‚úï</button>
                </div>
              }
            </div>
          </section>
        } @else {
          <div class="galeria galeria--empty">Sin im√°genes cargadas</div>
        }
      } @else {
        <label>Im√°genes <small class="hint">({{ imagenesPreview.length }} / 5)</small></label>
        @if (imagenesPreview.length > 0) {
          <section class="galeria">
            <div class="galeria__thumbs">
              @for (img of imagenesPreview; let i = $index; track $index) {
                <div class="thumb">
                  <img draggable="false" [src]="img.url" [alt]="'Imagen ' + (i + 1)" />
                </div>
              }
            </div>
          </section>
        } @else {
          <div class="galeria galeria--empty">Sin im√°genes cargadas</div>
        }
      }

      <!-- BOTONES -->
      <div class="actions">
        <button type="submit" [disabled]="loading || form.invalid">
          @if (loading) {
            <span>Guardando...</span>
          } @else {
            <span>{{ editMode ? 'Guardar cambios' : 'Crear habitaci√≥n' }}</span>
          }
        </button>
        <button type="button" class="btn-ghost" (click)="volver()">Cancelar</button>
      </div>
    </form>
  </section>
</main>