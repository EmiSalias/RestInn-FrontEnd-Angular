  @if (!isAdmin) {
    <h3 class="section-title">Habitaciones</h3>
  } @else {
    <h1 class="gest-habs" routerLink="/gestion_habitaciones">Gestión de habitaciones</h1>
    <h1>></h1>
    <h1>Listado de habitaciones</h1>
  }

<section class="habitaciones-list">
  <div class="filtros-toggle">
    <button type="button" (click)="abrirFiltros()">
      {{ filtrosVisibles ? 'Cerrar filtros' : 'Filtrar' }}
    </button>
    <button type="button" (click)="limpiarFiltros()">Limpiar filtros</button>

    @if (isAdmin) {
    <button type="button" (click)="agregarNueva()">Agregar nueva</button>
    }
  </div>

  <!-- FILTROS REACTIVOS DEL LISTADO -->
  @if (filtrosVisibles) {
  <form class="filtros" [class.activo]="filtrosVisibles">
    <div class="filtros-row">

      <!-- ORDENAMIENTO -->
      <div class="filtro"> <label for="orden">Ordenar por:</label>
        <select id="orden" [(ngModel)]="orden" name="orden" (change)="ordenarHabitaciones()">
          <option value="Numero asc">Número ↑</option>
          <option value="Numero desc">Número ↓</option>
          <option value="Precio asc">Precio ↑</option>
          <option value="Precio desc">Precio ↓</option>
          <option value="Capacidad asc">Capacidad ↑</option>
          <option value="Capacidad desc">Capacidad ↓</option>
        </select>
      </div>

      <!-- FILTRO ESTADO -->
      @if ( puedeGestionarHabitaciones ) {
      <div class="filtro">
        <label for="filtroEstado">Estado:</label>
        <select id="filtroEstado" [(ngModel)]="filtros.estado" name="estado">
          <option value="">Todos</option>
          <option value="DISPONIBLE">Disponible</option>
          <option value="OCUPADA">Ocupada</option>
          <option value="MANTENIMIENTO">Mantenimiento</option>
          <option value="LIMPIEZA">Limpieza</option>
        </select>
      </div>
      }

      <!-- FILTRO VISIBILIDAD (SOLO ADMIN)-->
      @if (isAdmin) {
      <div class="filtro">
        <label for="filtroActivo">Visibilidad:</label>
        <select id="filtroActivo" [(ngModel)]="filtros.filtroActivo" name="filtroActivo">
          <option value="todas">Todas</option>
          <option value="activas">Solo Activas</option>
          <option value="inactivas">Solo Inactivas</option>
        </select>
      </div>
      }

      <!-- FILTRO TIPO -->
      <div class="filtro">
        <label for="filtroTipo">Tipo:</label>
        <select id="filtroTipo" [(ngModel)]="filtros.tipo" name="tipo">
          <option value="">Todos</option>
          @for (tipo of tiposHabitacion; track tipo) {
          <option [value]="tipo">{{ tipo | titlecase }}</option>
          }
        </select>
      </div>

      <!-- FILTRO NUMERO -->
      <div class="filtro">
        <label for="filtroNumero">Número:</label>
        <input 
          id="filtroNumero" 
          type="number" 
          [(ngModel)]="filtros.numero" 
          (ngModelChange)="validarFiltros()" 
          name="numero" 
          min="1" 
          max="9999"
          placeholder="Ej: 101">
        @if (numeroError) {
          <small class="error">{{ numeroError }}</small>
        }
      </div>

      <!-- FILTRO PISO -->
      <div class="filtro">
        <label for="filtroPiso">Piso:</label>
        <input 
          id="filtroPiso" 
          type="number" 
          [(ngModel)]="filtros.piso" 
          (ngModelChange)="validarFiltros()" 
          name="piso" 
          min="1" 
          max="4" 
          placeholder="1-4">
        @if (pisoError) {
          <small class="error">{{ pisoError }}</small>
        }
      </div>

      <!-- FILTRO CAPACIDAD -->
      <div class="filtro-rango">
        <label>Capacidad:</label>
        <div class="filtro-rango-inputs">
          <input 
            type="number" 
            [(ngModel)]="filtros.capacidadMin" 
            (ngModelChange)="validarFiltros()" 
            name="capacidadMin" 
            min="1" 
            max="5" 
            placeholder="mín">
          <span>—</span>
          <input 
            type="number" 
            [(ngModel)]="filtros.capacidadMax" 
            (ngModelChange)="validarFiltros()" 
            name="capacidadMax" 
            min="1" 
            max="5" 
            placeholder="máx">
        </div>
        @if (capacidadError) {
          <small class="error">{{ capacidadError }}</small>
        }
      </div>

      <!-- FILTRO PRECIO -->
      <div class="filtro-rango">
        <label>Precio:</label>
        <div class="filtro-rango-inputs">
          <input 
            type="number" 
            [(ngModel)]="filtros.precioMin" 
            (ngModelChange)="validarFiltros()" 
            name="precioMin" 
            min="0.01" 
            max="999999999.99"
            step="0.01" 
            placeholder="mín $">
          <span>—</span>
          <input 
            type="number" 
            [(ngModel)]="filtros.precioMax" 
            (ngModelChange)="validarFiltros()" 
            name="precioMax" 
            min="0.01" 
            max="999999999.99"
            step="0.01" 
            placeholder="máx $">
        </div>
        @if (precioError) {
          <small class="error">{{ precioError }}</small>
        }
      </div>
    </div>

    <!-- BOTONES DE FILTROS -->
    <div class="filtros-bottom">
      <button 
        type="button" 
        (click)="aplicarFiltros()" 
        [disabled]="!filtrosValidos">
        Aplicar
      </button>

      <button type="button" (click)="cancelarFiltros()">Cancelar</button>
    </div>
  </form>
  }

  <!-- MUESTRA DE LISTADO REACTIVO -->
  @if (loading) {
  <p class="loading">Cargando habitaciones...</p>
  } @else if (errorMsg) {
  <p class="error">{{ errorMsg }}</p>
  } @else {
    <div class="habitaciones-grid">

      <!-- CARTAS DE HABITACIONES -->
      @for (hab of habitacionesFiltradas; track hab.id) {
        <div class="habitacion-card" [class.inactiva]="!hab.activo">

          <!-- INFO HABITACION -->
          <div class="habitacion-card__image-wrapper">
            @if (getMainImageDataUrl(hab)) {
              <img [src]="getMainImageDataUrl(hab)" [alt]="'Habitación ' + hab.numero" class="habitacion-card__image" />
            } @else {
              <div class="habitacion-card__image habitacion-card__image--placeholder">
                <p>No posee imágenes</p>
              </div>
            }
            @if (puedeGestionarHabitaciones) {
              <span class="habitacion-card__badge" [ngClass]="hab.estado.toLowerCase()">{{ hab.estado }}</span>
            }

            @if (isAdmin && !hab.activo) {
            <span class="habitacion-card__badge badge-inactiva">INACTIVA</span>
            }
          </div>

          <div class="habitacion-card__body">
            <div class="habitacion-card__title">Hab. {{ hab.numero }} · {{ hab.tipo }}</div>
            <div class="habitacion-card__sub">Piso {{ hab.piso }}</div>
            <div class="habitacion-card__details">
              <p>Capacidad: {{ hab.capacidad }}</p>
              <p>Camas: {{ hab.cantCamas }}</p>
              <p class="price">Precio/noche: ${{ hab.precioNoche }}</p>
            </div>
            @if (hab.comentario) {
              <div class="detail-row">
                <span class="label">Nota:</span>
                <span class="value">{{ hab.comentario }}</span>
              </div>
            }
          </div>

          <!-- BOTONES REACTIVOS -->
          <div class="buttons">
            @if (!isConserje && !isLimpieza) {
              <button (click)="reservarHabitacion(hab)">Reservar</button>
            }

            <button (click)="detailHabitacion(hab)">Detalle</button>

            @if (puedeGestionarHabitaciones) {
              @if (isAdmin || isRecepcionista) {
                <button class="btn-edit" (click)="editHabitacion(hab)">Editar</button>
              }
              @if (isAdmin) {
                @if (hab.activo) {
                  <button class="btn-delete" (click)="inhabilitarHabitacion(hab)">Inhabilitar</button>
                } @else {
                  <button class="btn-reactivate" (click)="reactivarHabitacion(hab)">Reactivar</button>
                }
              } @else if(!isRecepcionista) {
                <div class="field-toggle">
                  @if (isConserje) {
                    <label class="toggle-text">Modo Mantenimiento</label>
                  } @else if (isLimpieza) {
                    <label class="toggle-text">Modo Limpieza</label>
                  }
                  <label class="switch">
                    <input 
                      type="checkbox" 
                      id="estado-{{ hab.id }}" 
                      [checked]="isToggleChecked(hab)"
                      [disabled]="isToggleDisabled(hab)" 
                      (change)="onToggleChange(hab, $event)"
                    />
                    <span class="slider round"></span>
                  </label>
                </div>
              }
            }
          </div>
        </div>
      }
    </div>
  }
</section>