<section class="admin-reservations-page">
    <h1>{{ titulo }}</h1>
    <p class="subtitle">
        {{ subtitulo }}
    </p>

    <!-- FILTROS -->
    <div class="filters-panel">
        <div class="filters-row">

            <!-- Estado (ambos modos) -->
            <div class="filtro">
                <label>Estado</label>
                <select [(ngModel)]="filtros.estado" (change)="aplicarFiltros()">
                    <option value="">Todos</option>
                    <option value="PENDIENTE">Pendiente</option>
                    <option value="CONFIRMADA">Confirmada</option>
                    <option value="EN_CURSO">En curso</option>
                    <option value="FINALIZADA">Finalizada</option>
                    <option value="CANCELADA">Cancelada</option>
                </select>
            </div>

            <!-- Creada por (solo admin/recepción) -->
            @if (modoAdmin) {
              <div class="filtro">
                  <label>Creada por</label>
                  <select [(ngModel)]="filtros.rolUsuario" (change)="aplicarFiltros()">
                      <option value="">Cualquiera</option>
                      <option value="CLIENTE">Cliente</option>
                      <option value="RECEPCIONISTA">Recepcionista</option>
                      <option value="ADMINISTRADOR">Administrador</option>
                  </select>
              </div>

              <!-- Cliente (solo admin/recepción) -->
              <div class="filtro">
                  <label>Cliente</label>
                  <select [(ngModel)]="filtros.clienteId" (change)="aplicarFiltros()">
                      <option [ngValue]="null">Todos</option>
                      @for (c of clientesUnicos; track c.id) {
                        <option [ngValue]="c.id">
                          {{ c.nombre }}
                        </option>
                      }
                  </select>
              </div>
            }

            <!-- Fechas (ambos modos) -->
            <div class="filtro">
                <label>Fechas (ingreso / salida)</label>
                <div class="dates-filter">
                    <input type="date" [(ngModel)]="filtros.fechaDesde" (change)="aplicarFiltros()">
                    <span>—</span>
                    <input type="date" [(ngModel)]="filtros.fechaHasta" (change)="aplicarFiltros()">
                </div>
            </div>

            <!-- Buscar (ambos modos) -->
            <div class="filtro filtro-search">
                <label>Buscar</label>
                <input type="text" [(ngModel)]="filtros.search" (input)="aplicarFiltros()"
                    placeholder="Nombre, #reserva, #hab..." />
            </div>

            <!-- Orden (ambos modos) -->
            <div class="filtro">
                <label>Ordenar por</label>
                <select [(ngModel)]="orden" (change)="ordenar()">
                    <option value="ingresoDesc">Ingreso más reciente</option>
                    <option value="ingresoAsc">Ingreso más antiguo</option>
                    <option value="estado">Estado</option>
                </select>
            </div>

        </div>

        <div class="filters-actions">
            <button type="button" (click)="limpiarFiltros()">Limpiar filtros</button>
        </div>
    </div>

    <!-- RESUMEN -->
    @if (!loading && !errorMsg && reservasFiltradas.length > 0) {
      <div class="reservations-summary">
        Mostrando {{ reservasFiltradas.length }} reservas.
      </div>
    }

    @if (loading) {
      <div class="status">Cargando reservas...</div>
    }
    @if (!loading && errorMsg) {
      <div class="status error">{{ errorMsg }}</div>
    }

    <!-- GRID -->
    @if (!loading && !errorMsg && reservasFiltradas.length > 0) {
      <div class="reservations-grid">

        @for (r of reservasFiltradas; track r.id) {
          <article class="reservation-card">
              <div class="reservation-main">
                  <!-- FOTO DE LA HABITACIÓN -->
                  <div class="thumb-wrapper">
                      <img [src]="getHabitacionThumb(r.habitacionId) || defaultRoomImg"
                          alt="Habitación {{ r.habitacionNumero || r.habitacionId }}" (error)="onImgError($event)" />
                  </div>

                  <!-- CONTENIDO -->
                  <div class="reservation-main-content">
                      <header class="reservation-header">
                          <div>
                              <div class="room-tag">
                                  Habitación {{ r.habitacionNumero || r.habitacionId }}
                              </div>

                              @if (modoAdmin) {
                                <div class="client-line">
                                  {{ r.usuario?.nombre }} {{ r.usuario?.apellido }}
                                  ·
                                  <span class="client-role">
                                      {{ rolLabel(r.usuario?.role) }}
                                  </span>
                                </div>
                              }
                          </div>

                          <span class="status-chip" [ngClass]="r.estado?.toLowerCase()">
                              {{ estadoLabel(r.estado) }}
                          </span>
                      </header>

                      <div class="reservation-body">
                          <div class="dates">
                              <div>
                                  <span class="label">Ingreso</span>
                                  <span class="value">
                                      {{ r.fechaIngreso | date:'dd/MM/yyyy' }}
                                  </span>
                              </div>
                              <div>
                                  <span class="label">Salida</span>
                                  <span class="value">
                                      {{ r.fechaSalida | date:'dd/MM/yyyy' }}
                                  </span>
                              </div>
                          </div>

                          <div class="extra">
                              <span>{{ contarHuespedes(r) }} huésped(es)</span>
                              <span>Reserva #{{ r.id }}</span>
                          </div>
                      </div>
                  </div>
              </div>

              <footer class="reservation-footer">
                  <button class="btn-gold" [routerLink]="['/reserva', r.id]">
                      Ver detalle
                  </button>
                  @if (puedeCancelar(r)) {
                    <button type="button" class="btn-danger-outline" (click)="onCancelarClick(r)">
                      Cancelar reserva
                    </button>
                  }
              </footer>

          </article>
        }
      </div>
    } @else if (!loading && !errorMsg) {
      <div class="empty">
        No se encontraron reservas con los filtros actuales.
      </div>
    }
</section>